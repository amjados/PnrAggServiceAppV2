<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PNR Service Calls - Database Online</title>
    <link rel="stylesheet" href="css_common.css">
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <script src="js_common.js" defer></script>
</head>

<body>
    <div class="container">

        <h2>Sequence Diagram: Service Calls with Database Online</h2>

        <p>Complete request flow when end user requests <code>http://localhost:8080/booking/GHTW42</code> with MongoDB
            online and one WebSocket client connected. Shows successful parallel execution, EventBus publishing, and
            real-time WebSocket notification.</p>

        <iframe src="pnr_uml_seq_dig_Service_Calls_db_on_diagram.html"
            style="width: 100%; height: 800px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa;">
        </iframe>

        <div class="note">
            <strong>Architecture Pattern:</strong> Reactive parallel processing with Vert.x Futures for Trip, Baggage,
            and Tickets. All services protected by Circuit Breakers in CLOSED state. EventBus publishes pnr.fetched
            event consumed by both logger and WebSocket handler for real-time notifications.
        </div>

        <div class="summary">
            <h3>Key Points</h3>
            <ul>
                <li><strong>Parallel Execution:</strong> Trip and Baggage fetched simultaneously, followed by parallel
                    ticket queries</li>
                <li><strong>Circuit Breaker Protection:</strong> All MongoDB operations protected, state CLOSED allows
                    requests</li>
                <li><strong>Graceful Handling:</strong> Missing tickets handled with .recover() pattern, returns null
                    without failing</li>
                <li><strong>Event-Driven:</strong> Single event published to EventBus, consumed by multiple handlers
                </li>
                <li><strong>Real-Time Updates:</strong> WebSocket broadcasts to all connected clients immediately</li>
                <li><strong>Dual Response:</strong> HTTP client receives response, WebSocket client receives
                    notification</li>
            </ul>
        </div>

        <div class="summary">
            <h3 class="pros">Success Scenario</h3>
            <ul>
                <li><strong>Database Available:</strong> MongoDB responds successfully to all queries</li>
                <li><strong>Circuit Breakers Healthy:</strong> All circuit breakers in CLOSED state</li>
                <li><strong>Complete Data:</strong> Full booking response with trip, baggage, and available tickets</li>
                <li><strong>Fast Performance:</strong> Parallel execution reduces total response time</li>
                <li><strong>Real-Time Notification:</strong> WebSocket client receives immediate update</li>
            </ul>
        </div>

    </div>
</body>

</html>