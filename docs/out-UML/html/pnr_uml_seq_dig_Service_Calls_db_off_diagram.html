<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Diagram Only - Service Calls DB Offline</title>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <script src="js_common.js" defer></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #fafafa;
        }

        .mermaid {
            font-size: 16px;
        }

        .mermaid svg {
            min-width: 4800px;
            width: auto !important;
            height: auto !important;
        }

        .participant-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            white-space: nowrap;
        }

        .lifeline-colored {
            cursor: pointer;
            transition: stroke-width 0.2s, opacity 0.2s;
        }

        .lifeline-colored:hover {
            stroke-width: 4px !important;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="mermaid">
        sequenceDiagram
        autonumber

        actor Client as HTTP Client
        actor WSClient as WebSocket Client
        participant C as BookingController
        participant AGG as BookingAggregatorService
        participant TS as TripService
        participant CB as Circuit Breaker tripServiceCB
        participant DB as MongoDB DOWN
        participant Cache as Redis Cache Fallback
        participant EB as Vert.x EventBus pnr.fetched
        participant LOG as PnrEventConsumer
        participant WSH as PNRWebSocketHandler
        participant Sessions as Active Sessions

        Note over WSClient,Sessions: WebSocket Connected
        WSClient->>Sessions: ws://localhost:8080/ws/pnr

        Client->>C: GET /booking/GHTW42
        C->>AGG: aggregateBooking("GHTW42")
        AGG->>TS: getTripInfo("GHTW42")

        Note over DB: MongoDB is DOWN - or responding slowly

        TS->>CB: Check circuit state
        Note over CB: State: CLOSED - Failures: 4/5 Near threshold

        CB->>DB: find("trips", ...)
        DB--xCB: Connection timeout (5s)

        Note over CB: Failure recorded - Threshold reached State: CLOSED to OPEN

        CB->>CB: Open circuit for 60 seconds
        CB--xTS: CircuitBreakerOpenException

        TS->>TS: Invoke fallbackMethod getTripFallback()
        TS->>Cache: Get cached trip for "GHTW42"
        Cache-->>TS: Cached trip data (5 minutes old)

        Note over TS: Set fallback metadata: - fromCache=true cacheTimestamp=now pnrFallbackMsg="From cache"

        TS-->>AGG: Future Trip (from cache)

        Note over AGG: Continue with baggage - and tickets (may also fail)

        AGG->>AGG: mergeData(trip, baggage, tickets)
        Note over AGG: Build BookingResponse - status: "DEGRADED" fromCache: true pnrFallbackMsg: [...]

        AGG->>EB: publish("pnr.fetched", event) {pnr:"GHTW42", status:"DEGRADED", timestamp}

        par EventBus Multi-Consumer Broadcast
        EB->>LOG: consume message
        Note over LOG: Log to console: - [EventBus] PNR GHTW42 fetched with status DEGRADED
        LOG->>LOG: Write to console
        and
        EB->>WSH: consume message
        Note over WSH: WebSocketHandler receives event
        WSH->>Sessions: Get all active sessions
        Sessions-->>WSH: Set of WebSocketSession
        loop For each session in sessions
        alt Session is open
        WSH->>WSClient: session.sendMessage(TextMessage) JSON: {pnr:"GHTW42", status:"DEGRADED"}
        Note over WSClient: ws.onmessage() triggered - Display in browser UI
        else Session closed
        Note over WSH: Skip closed session - IOException caught
        end
        end
        end
    </div>
</body>

</html>