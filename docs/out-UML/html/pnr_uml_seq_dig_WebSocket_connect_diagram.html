<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Diagram Only - WebSocket Connection Lifecycle</title>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <script src="js_common.js" defer></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #fafafa;
        }

        .mermaid {
            font-size: 16px;
        }

        .mermaid svg {
            min-width: 2400px;
            width: auto !important;
            height: auto !important;
        }

        .participant-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            white-space: nowrap;
        }

        .lifeline-colored {
            cursor: pointer;
            transition: stroke-width 0.2s, opacity 0.2s;
        }

        .lifeline-colored:hover {
            stroke-width: 4px !important;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="mermaid">
        sequenceDiagram
        autonumber

        actor Client as Browser Client
        participant HTML as websocket-test.html
        participant WS as WebSocket API
        participant Server as Spring WebSocket /ws/pnr
        participant Handler as PNRWebSocketHandler
        participant Sessions as ConcurrentHashMap sessions
        participant EB as Vert.x EventBus @PostConstruct

        Note over Client,EB: Phase 1: Initial Connection

        Client->>HTML: Click "Connect" button
        HTML->>WS: new WebSocket("ws://localhost:8080/ws/pnr")
        WS->>Server: WebSocket Handshake (HTTP Upgrade)
        Server->>Handler: afterConnectionEstablished(session)
        Handler->>Sessions: sessions.add(session)
        Note over Sessions: Store session reference - (thread-safe ConcurrentHashMap)
        Handler-->>Server: Connection established
        Server-->>WS: 101 Switching Protocols
        WS-->>HTML: ws.onopen()
        HTML->>Client: Display: "Connected"

        Note over Client,EB: Phase 2: Event Subscription (happens once on startup)

        Note over Handler,EB: Handler initialized via @PostConstruct
        Handler->>EB: eventBus.consumer("pnr.fetched", handler)
        Note over EB: Handler registered - Listens for all pnr.fetched events

        Note over Client,EB: Connection Active - Ready to Receive Messages
    </div>
</body>

</html>