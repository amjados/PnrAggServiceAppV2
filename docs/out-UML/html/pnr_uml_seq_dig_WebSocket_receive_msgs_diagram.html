<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Diagram Only - WebSocket Receiving Messages</title>
    <script type="module">
        import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <script src="js_common.js" defer></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: #fafafa;
        }

        .mermaid {
            font-size: 16px;
        }

        .mermaid svg {
            min-width: 3200px;
            width: auto !important;
            height: auto !important;
        }

        .participant-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 10000;
            display: none;
            white-space: nowrap;
        }

        .lifeline-colored {
            cursor: pointer;
            transition: stroke-width 0.2s, opacity 0.2s;
        }

        .lifeline-colored:hover {
            stroke-width: 4px !important;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="mermaid">
        sequenceDiagram
        autonumber

        actor HTTPClient as HTTP Client
        actor WSClient as WebSocket Client
        participant AGG as BookingAggregatorService
        participant EB as Vert.x EventBus pnr.fetched
        participant LOG as PnrEventConsumer Logger
        participant WSH as PNRWebSocketHandler Broadcaster
        participant Sessions as Active Sessions ConcurrentHashMap

        Note over HTTPClient,Sessions: Prerequisite: WebSocket Already Connected
        Note over WSClient,Sessions: Connection established via - ws://localhost:8080/ws/pnr

        Note over HTTPClient,Sessions: Scenario 1: Database Online (Success)

        HTTPClient->>AGG: HTTP GET /booking/GHTW42
        Note over AGG: Process request - Query MongoDB Merge data

        AGG->>EB: publish("pnr.fetched", event) {pnr:"GHTW42", status:"SUCCESS", timestamp}

        par EventBus Multi-Consumer Pattern
        EB->>LOG: consumer.handle(message)
        Note over LOG: Extract event data
        LOG->>LOG: log.info("[EventBus] PNR GHTW42 - fetched with status SUCCESS")
        and
        EB->>WSH: consumer.handle(message)
        Note over WSH: Extract JsonObject: - {pnr, status, timestamp}
        WSH->>WSH: broadcast(event.encode())
        WSH->>Sessions: Get all active sessions
        Sessions-->>WSH: Set of WebSocketSession

        loop For each session in sessions
        alt Session is open
        WSH->>WSClient: session.sendMessage(TextMessage) JSON: {pnr:"GHTW42", status:"SUCCESS"}
        Note over WSClient: ws.onmessage() triggered - Display in browser UI
        else Session closed
        Note over WSH: Skip closed session - IOException caught
        end
        end
        end

        Note over HTTPClient,Sessions: Scenario 2: Database Offline (Degraded)

        HTTPClient->>AGG: HTTP GET /booking/GHTW42
        Note over AGG: Process request - MongoDB fails Circuit Breaker opens Fallback to cache

        AGG->>EB: publish("pnr.fetched", event) {pnr:"GHTW42", status:"DEGRADED", timestamp}

        par EventBus Multi-Consumer Pattern
        EB->>LOG: consumer.handle(message)
        LOG->>LOG: log.info("[EventBus] PNR GHTW42 fetched with status DEGRADED")
        and
        EB->>WSH: consumer.handle(message)
        WSH->>WSH: broadcast(event.encode())
        WSH->>Sessions: Get all active sessions
        Sessions-->>WSH: Set of WebSocketSession

        loop For each session in sessions
        alt Session is open
        WSH->>WSClient: session.sendMessage(TextMessage) JSON: {pnr:"GHTW42", status:"DEGRADED"}
        Note over WSClient: ws.onmessage() triggered - Display in browser UI
        else Session closed
        Note over WSH: Skip closed session - IOException caught
        end
        end
        end
    </div>
</body>

</html>